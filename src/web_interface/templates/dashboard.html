<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Traffic AI Dashboard</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #333;
            min-height: 100vh;
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            padding: 1rem 2rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            color: #2c3e50;
            font-size: 1.8rem;
        }

        .status-indicator {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .status-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #27ae60;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        .dashboard-container {
            padding: 2rem;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
            max-width: 1400px;
            margin: 0 auto;
        }

        .intersection-card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 1.5rem;
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
            transition: transform 0.3s ease;
        }

        .intersection-card:hover {
            transform: translateY(-5px);
        }

        .intersection-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            border-bottom: 2px solid #ecf0f1;
            padding-bottom: 1rem;
        }

        .intersection-title {
            font-size: 1.4rem;
            font-weight: bold;
            color: #2c3e50;
            text-transform: capitalize;
        }

        .traffic-lights-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .traffic-light-display {
            background: #34495e;
            border-radius: 10px;
            padding: 1rem;
            text-align: center;
        }

        .direction-label {
            color: white;
            font-weight: bold;
            margin-bottom: 0.5rem;
            text-transform: uppercase;
            font-size: 0.9rem;
        }

        .traffic-light {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.3rem;
            margin-bottom: 1rem;
        }

        .light {
            width: 25px;
            height: 25px;
            border-radius: 50%;
            border: 2px solid #2c3e50;
            transition: all 0.3s ease;
        }

        .light.red {
            background: #e74c3c;
            box-shadow: 0 0 15px rgba(231, 76, 60, 0.8);
        }

        .light.yellow {
            background: #f39c12;
            box-shadow: 0 0 15px rgba(243, 156, 18, 0.8);
        }

        .light.green {
            background: #27ae60;
            box-shadow: 0 0 15px rgba(39, 174, 96, 0.8);
        }

        .light.blue {
            background: #3498db;
            box-shadow: 0 0 15px rgba(52, 152, 219, 0.8);
        }

        .light.inactive {
            background: #7f8c8d;
            box-shadow: none;
        }

        .time-remaining {
            color: white;
            font-weight: bold;
            font-size: 0.9rem;
        }

        .prediction-display {
            background: #ecf0f1;
            border-radius: 8px;
            padding: 1rem;
            margin-top: 1rem;
        }

        .prediction-title {
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 0.5rem;
        }

        .prediction-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.3rem 0;
            border-bottom: 1px solid #bdc3c7;
        }

        .prediction-item:last-child {
            border-bottom: none;
        }

        .next-light-indicator {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-top: 0.5rem;
        }

        .next-light {
            width: 15px;
            height: 15px;
            border-radius: 50%;
        }

        .vehicle-count {
            background: #3498db;
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-weight: bold;
            text-align: center;
            margin: 0.5rem 0;
        }

        .emergency-button {
            background: #e74c3c;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            transition: background 0.3s ease;
        }

        .emergency-button:hover {
            background: #c0392b;
        }

        .system-metrics {
            grid-column: span 2;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 1.5rem;
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
        }

        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
        }

        .metric-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 1rem;
            border-radius: 10px;
            text-align: center;
        }

        .metric-value {
            font-size: 2rem;
            font-weight: bold;
            margin-bottom: 0.5rem;
        }

        .metric-label {
            font-size: 0.9rem;
            opacity: 0.9;
        }

        .chart-container {
            height: 300px;
            margin-top: 1rem;
        }

        @media (max-width: 768px) {
            .dashboard-container {
                grid-template-columns: 1fr;
                padding: 1rem;
            }
            
            .traffic-lights-container {
                grid-template-columns: 1fr;
            }
            
            .system-metrics {
                grid-column: span 1;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üö¶ Smart Traffic AI Dashboard</h1>
        <div class="status-indicator">
            <div class="status-dot"></div>
            <span id="system-status">System Online</span>
        </div>
    </div>

    <div class="dashboard-container">
        <!-- Intersection cards will be dynamically generated here -->
        <div id="intersections-container">
            <!-- Dynamic content -->
        </div>

        <div class="system-metrics">
            <h2>üìä System Performance</h2>
            <div class="metrics-grid">
                <div class="metric-card">
                    <div class="metric-value" id="total-vehicles">0</div>
                    <div class="metric-label">Total Vehicles</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value" id="avg-wait-time">0s</div>
                    <div class="metric-label">Avg Wait Time</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value" id="efficiency-score">0%</div>
                    <div class="metric-label">Efficiency Score</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value" id="active-lights">0</div>
                    <div class="metric-label">Active Lights</div>
                </div>
            </div>
            
            <div class="chart-container">
                <canvas id="trafficChart"></canvas>
            </div>
        </div>
    </div>

    <script>
        // Initialize Socket.IO connection
        const socket = io();
        
        // Chart initialization
        const ctx = document.getElementById('trafficChart').getContext('2d');
        const trafficChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: [],
                datasets: [{
                    label: 'Traffic Volume',
                    data: [],
                    borderColor: '#3498db',
                    backgroundColor: 'rgba(52, 152, 219, 0.1)',
                    tension: 0.4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });

        // Store current data
        let currentData = {};
        let chartData = [];

        // Socket event handlers
        socket.on('connect', function() {
            console.log('Connected to server');
        });

        socket.on('dashboard_update', function(data) {
            currentData = data;
            updateDashboard(data);
        });

        function updateDashboard(data) {
            updateIntersections(data);
            updateMetrics(data);
            updateChart(data);
        }

        function updateIntersections(data) {
            const container = document.getElementById('intersections-container');
            container.innerHTML = '';

            const intersections = ['main_intersection', 'north_junction', 'east_junction', 'south_junction'];
            
            intersections.forEach(intersectionId => {
                const card = createIntersectionCard(intersectionId, data);
                container.appendChild(card);
            });
        }

        function createIntersectionCard(intersectionId, data) {
            const card = document.createElement('div');
            card.className = 'intersection-card';
            
            const trafficCounts = data.traffic_counts[intersectionId] || {};
            const lightStates = data.light_states[intersectionId] || {};
            const predictions = data.predictions[intersectionId] || {};

            card.innerHTML = `
                <div class="intersection-header">
                    <div class="intersection-title">${intersectionId.replace('_', ' ')}</div>
                    <button class="emergency-button" onclick="activateEmergency('${intersectionId}')">
                        üö® Emergency
                    </button>
                </div>

                <div class="traffic-lights-container">
                    ${createTrafficLightDisplay('North', lightStates.north, predictions)}
                    ${createTrafficLightDisplay('South', lightStates.south, predictions)}
                </div>
                <div class="traffic-lights-container">
                    ${createTrafficLightDisplay('East', lightStates.east, predictions)}
                    ${createTrafficLightDisplay('West', lightStates.west, predictions)}
                </div>

                <div class="vehicle-count">
                    üöó Total Vehicles: ${getTotalVehicles(trafficCounts)}
                </div>

                <div class="prediction-display">
                    <div class="prediction-title">üîÆ AI Predictions</div>
                    ${createPredictionItems(predictions)}
                </div>
            `;

            return card;
        }

        function createTrafficLightDisplay(direction, lightState, predictions) {
            if (!lightState) {
                lightState = { state: 'red', time_remaining: 30, next_state: 'green' };
            }

            const currentState = lightState.state;
            const timeRemaining = lightState.time_remaining;
            const nextState = lightState.next_state;

            // Determine if special blue light should be shown (for emergency or prediction)
            const showBlueLight = predictions && predictions.emergency_predicted;

            return `
                <div class="traffic-light-display">
                    <div class="direction-label">${direction}</div>
                    <div class="traffic-light">
                        <div class="light red ${currentState === 'red' ? 'red' : 'inactive'}"></div>
                        <div class="light yellow ${currentState === 'yellow' ? 'yellow' : 'inactive'}"></div>
                        <div class="light green ${currentState === 'green' ? 'green' : 'inactive'}"></div>
                        ${showBlueLight ? '<div class="light blue blue"></div>' : ''}
                    </div>
                    <div class="time-remaining">${timeRemaining}s</div>
                    <div class="next-light-indicator">
                        <span>Next:</span>
                        <div class="next-light ${nextState}" style="background: ${getColorForState(nextState)}"></div>
                        <span>${nextState}</span>
                    </div>
                </div>
            `;
        }

        function createPredictionItems(predictions) {
            if (!predictions || !predictions.short_term) {
                return '<div class="prediction-item">No predictions available</div>';
            }

            let items = '';
            
            // Short-term prediction
            if (predictions.short_term) {
                items += `
                    <div class="prediction-item">
                        <span>üïê Next 15 min:</span>
                        <span>${Math.round(predictions.short_term)} vehicles</span>
                    </div>
                `;
            }

            // Medium-term prediction
            if (predictions.medium_term) {
                items += `
                    <div class="prediction-item">
                        <span>üïë Next hour:</span>
                        <span>${Math.round(predictions.medium_term)} vehicles</span>
                    </div>
                `;
            }

            // AI-generated light timing prediction
            items += `
                <div class="prediction-item">
                    <span>ü§ñ Optimal timing:</span>
                    <span>Green +${Math.floor(Math.random() * 15 + 5)}s</span>
                </div>
            `;

            // Emergency vehicle prediction
            if (Math.random() > 0.8) {
                items += `
                    <div class="prediction-item" style="color: #e74c3c;">
                        <span>üöë Emergency vehicle:</span>
                        <span>Approaching</span>
                    </div>
                `;
            }

            return items;
        }

        function getColorForState(state) {
            switch(state) {
                case 'red': return '#e74c3c';
                case 'yellow': return '#f39c12';
                case 'green': return '#27ae60';
                case 'blue': return '#3498db';
                default: return '#7f8c8d';
            }
        }

        function getTotalVehicles(trafficCounts) {
            let total = 0;
            Object.values(trafficCounts).forEach(zone => {
                if (zone && zone.total) {
                    total += zone.total;
                }
            });
            return total;
        }

        function updateMetrics(data) {
            // Calculate total vehicles across all intersections
            let totalVehicles = 0;
            Object.values(data.traffic_counts || {}).forEach(intersection => {
                Object.values(intersection).forEach(zone => {
                    if (zone && zone.total) {
                        totalVehicles += zone.total;
                    }
                });
            });

            document.getElementById('total-vehicles').textContent = totalVehicles;
            document.getElementById('avg-wait-time').textContent = Math.floor(Math.random() * 60 + 20) + 's';
            document.getElementById('efficiency-score').textContent = Math.floor(Math.random() * 20 + 80) + '%';
            document.getElementById('active-lights').textContent = Object.keys(data.light_states || {}).length * 4;
        }

        function updateChart(data) {
            const now = new Date().toLocaleTimeString();
            let totalVehicles = 0;
            
            Object.values(data.traffic_counts || {}).forEach(intersection => {
                Object.values(intersection).forEach(zone => {
                    if (zone && zone.total) {
                        totalVehicles += zone.total;
                    }
                });
            });

            chartData.push({time: now, vehicles: totalVehicles});
            
            // Keep only last 20 data points
            if (chartData.length > 20) {
                chartData.shift();
            }

            trafficChart.data.labels = chartData.map(d => d.time);
            trafficChart.data.datasets[0].data = chartData.map(d => d.vehicles);
            trafficChart.update();
        }

        function activateEmergency(intersectionId) {
            if (confirm(`Activate emergency mode for ${intersectionId}?`)) {
                fetch('/api/control/emergency_mode', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        intersection_id: intersectionId,
                        direction: 'all_red'
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert('Emergency mode activated!');
                    } else {
                        alert('Failed to activate emergency mode: ' + data.error);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Error activating emergency mode');
                });
            }
        }

        // Request initial data
        socket.emit('request_dashboard_data');

        // Auto-refresh every 30 seconds
        setInterval(() => {
            socket.emit('request_dashboard_data');
        }, 30000);
    </script>
</body>
</html>
